<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>KiiHelper/KiiBase.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="KiiGatewayAgent.html">KiiGatewayAgent</a><ul class='methods'><li data-type='method'><a href="KiiGatewayAgent.html#activateEndnodeOnlineDetecting">activateEndnodeOnlineDetecting</a></li><li data-type='method'><a href="KiiGatewayAgent.html#getEndnode">getEndnode</a></li><li data-type='method'><a href="KiiGatewayAgent.html#isGatewayOnboarding">isGatewayOnboarding</a></li><li data-type='method'><a href="KiiGatewayAgent.html#onboardEndnodeByOwner">onboardEndnodeByOwner</a></li><li data-type='method'><a href="KiiGatewayAgent.html#onboardGatewayByOwner">onboardGatewayByOwner</a></li><li data-type='method'><a href="KiiGatewayAgent.html#setApp">setApp</a></li><li data-type='method'><a href="KiiGatewayAgent.html#setTemporaryApp">setTemporaryApp</a></li><li data-type='method'><a href="KiiGatewayAgent.html#setTemporaryUser">setTemporaryUser</a></li><li data-type='method'><a href="KiiGatewayAgent.html#setUser">setUser</a></li><li data-type='method'><a href="KiiGatewayAgent.html#updateEndnodeConnectivityByVendorThingID">updateEndnodeConnectivityByVendorThingID</a></li><li data-type='method'><a href="KiiGatewayAgent.html#updateEndnodeOnline">updateEndnodeOnline</a></li><li data-type='method'><a href="KiiGatewayAgent.html#updateEndnodeState">updateEndnodeState</a></li></ul></li><li><a href="Paho.MQTT.Client.html">Client</a><ul class='methods'><li data-type='method'><a href="Paho.MQTT.Client.html#connect">connect</a></li><li data-type='method'><a href="Paho.MQTT.Client.html#disconnect">disconnect</a></li><li data-type='method'><a href="Paho.MQTT.Client.html#getTraceLog">getTraceLog</a></li><li data-type='method'><a href="Paho.MQTT.Client.html#send">send</a></li><li data-type='method'><a href="Paho.MQTT.Client.html#startTrace">startTrace</a></li><li data-type='method'><a href="Paho.MQTT.Client.html#stopTrace">stopTrace</a></li><li data-type='method'><a href="Paho.MQTT.Client.html#subscribe">subscribe</a></li><li data-type='method'><a href="Paho.MQTT.Client.html#unsubscribe">unsubscribe</a></li></ul></li><li><a href="Paho.MQTT.Message.html">Message</a></li></ul><h3>Namespaces</h3><ul><li><a href="Paho.MQTT.html">MQTT</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">KiiHelper/KiiBase.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/// &lt;reference types='node' />
"use strict";
var Q = require("q");
var request = require("request");
// import low = require('lowdb');
var model_1 = require("../model");
var KiiBase = (function () {
    function KiiBase() {
        this.counter = 0;
        this.maxRequest = 10;
        if (global.gc)
            console.log('gc mode.');
        this.gateway = new model_1.Gateway();
    }
    /**
     * set kii app
     *
     * @param {any} _appID
     * @param {any} _appKey
     * @param {any} _site
     *
     * @memberOf KiiBase
     */
    KiiBase.prototype.setApp = function (_appID, _appKey, _site) {
        this.app = new model_1.App(_appID, _appKey, _site);
    };
    /**
     * set user
     *
     * @param {any} ownerToken
     * @param {any} ownerID
     *
     * @memberOf KiiBase
     */
    KiiBase.prototype.setUser = function (ownerToken, ownerID) {
        this.user = new model_1.User(ownerToken, ownerID);
    };
    /**
     * today date
     *
     * @returns {string}
     *
     * @memberOf KiiBase
     */
    KiiBase.prototype.today = function () {
        var today = new Date();
        var day = today.getDate();
        var month = today.getMonth() + 1;
        var year = today.getFullYear();
        return "" + year + month + day;
    };
    /**
     * onboard gateway by owner
     *
     * @abstract
     * @param {any} [properties]
     *
     * @memberOf KiiBase
     */
    KiiBase.prototype.onboardGatewayByOwner = function (properties) {
        var _this = this;
        var body = {
            'vendorThingID': this.gateway.vendorThingID,
            'thingPassword': this.gateway.password,
            'thingType': this.gateway.type,
            'owner': "USER:" + this.user.userID,
            'layoutPosition': 'GATEWAY'
        };
        if (properties)
            body['thingProperties'] = properties;
        var deferred = Q.defer();
        var options = {
            method: 'POST',
            url: this.app.site + "/thing-if/apps/" + this.app.appID + "/onboardings",
            headers: {
                authorization: "Bearer " + this.user.ownerToken,
                'content-type': 'application/vnd.kii.onboardingWithVendorThingIDByOwner+json'
            },
            body: JSON.stringify(body)
        };
        request(options, function (error, response, body) {
            _this.gcByCounter();
            if (error)
                deferred.reject(new Error(error));
            body = JSON.parse(body);
            _this.gateway.thingID = body.thingID;
            _this.gateway.accessToken = body.accessToken;
            _this.gateway.mqttEndpoint = body.mqttEndpoint;
            deferred.resolve(_this.gateway);
        });
        return deferred.promise;
    };
    KiiBase.prototype.gcByCounter = function () {
        if (!global.gc)
            return;
        if (this.counter &lt; this.maxRequest) {
            this.counter++;
        }
        else {
            this.counter = 0;
            global.gc();
        }
    };
    KiiBase.prototype.gcByTime = function () {
        if (!global.gc)
            return;
        setInterval(function () {
            global.gc();
        }, 60000);
    };
    return KiiBase;
}());
exports.KiiBase = KiiBase;
//# sourceMappingURL=KiiBase.js.map</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Thu Mar 02 2017 11:36:21 GMT+0800 (CST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
